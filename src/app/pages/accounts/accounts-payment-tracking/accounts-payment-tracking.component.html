<div class="d-flex d-flex-column">
  <div class="d-flex flex-grow-1">
    <div class="page-header responsive-margins">Payment Tracking</div>
  </div>
</div>

<div class="d-flex flex-grow-1 responsive-margins">
  <div class="app-card flex-grow-1">
    <div class="d-flex flex-row flex-wrap w-100 mb-3 pt-3 pl-4">
      <app-grid-search-text-box (changed)="searchTermValue = $event; onSearchInputChangedHandler()" class="mr-3">
      </app-grid-search-text-box>

      <dx-select-box *ngIf="userStore.isMedSecUser()" [dataSource]="sites" valueExpr="siteId" displayExpr="siteName"
        (onSelectionChanged)="setSelectedSiteItem($event)" class="no-bg-dropdown dx-custom-button-hovered"
        [(value)]="defaultSiteId">
      </dx-select-box>

      <dx-select-box [dataSource]="statuses" valueExpr="value" displayExpr="text"
        (onSelectionChanged)="statusChanged($event)" class="no-bg-dropdown dx-custom-button-hovered mr-3  ml-3"
        [(value)]="selectedStatus">
      </dx-select-box>

      <!-- <app-button text="Export" icon="far fa-file-download" class="mt-auto mb-auto ml-auto mr-4" type="link"
      (clicked)="export()"></app-button> -->
    </div>

    <div class="cssWidgetWrapper disable-select hmin-275px">
      <dx-data-grid gridWithRowLinesSettings [dataSource]="dataSource" keyExpr="this" [hoverStateEnabled]="true"
        class="cssGridGeneral padd-first-lg" [rowAlternationEnabled]="true" [showRowLines]="true" focusedRowIndex="0"
        (onFocusedRowChanged)="onFocusedRowChanged($event)" [focusedRowEnabled]="true" [remoteOperations]="false"
        (onRowDblClick)="openInvoice($event)">
        <dxo-scrolling mode="virtual"></dxo-scrolling>
        <dxo-state-storing [enabled]="true" type="sessionStorage" storageKey="paymentTrackingListStorage">
        </dxo-state-storing>

        <dxi-column dataField="siteName" [allowSorting]="true"
          [visible]="userStore.isMedSecUser() && !this.userStore.hasSelectedASite()" caption="Site" [minWidth]="120">
        </dxi-column>
        <dxi-column dataField="invoiceDate" caption="Invoice Date" dataType="date" [format]="appInfo.getDateFormat"
          [minWidth]="120">
        </dxi-column>
        <dxi-column dataField="invoiceNumber" caption="Invoice No." [minWidth]="120"></dxi-column>
        <dxi-column dataField="patientText" caption="Patient Name" [minWidth]="200"></dxi-column>
        <dxi-column dataField="totalGross" caption="Amount" cellTemplate="currency" [minWidth]="120"></dxi-column>
        <dxi-column dataField="dueNett" caption="Balance Due" cellTemplate="currency" [minWidth]="120"></dxi-column>

        <dxi-column type="buttons" [minWidth]="100">
          <dxi-button template="myCommandTemplate"></dxi-button>
        </dxi-column>

        <div *dxTemplate="let d of 'status'">
          <div class="current-value" *ngIf="d.value === 'balanced'">Balanced</div>
          <div class="current-value" *ngIf="d.value === 'issued' || d.value === 'Issued'">Issued</div>
          <div class="current-value" *ngIf="selectedStatus === 'overdue'">Overdue</div>
          <div class="current-value" *ngIf="selectedStatus === 'band1'">Band 1</div>
          <div class="current-value" *ngIf="selectedStatus === 'band2'">Band 2</div>
          <div class="current-value" *ngIf="selectedStatus === 'band3'">Band 3</div>
          <div class="current-value" *ngIf="selectedStatus === 'band4'">Band 4</div>
        </div>

        <div *dxTemplate="let d of 'currency'" valueFormat="fixedPoint {2}">
          <div class="current-value" *ngIf="d.value > 0">{{appInfo.getCurrencySymbol}} {{d.value | number : '1.2-2' }}
          </div>
          <div class="current-value" *ngIf="d.value === 0">-</div>
        </div>

        <div *dxTemplate="let cellInfo of 'myCommandTemplate'" class="d-flex flex-row">
          <app-button type="link" color="grey" icon="far fa-clone" class="mr-2 pointer-events-all"
            (clicked)="cloneInvoice(cellInfo)" matTooltip="Copy invoice">
          </app-button>

          <app-button type="link" color="grey" icon="far fa-pound-sign" class="mr-2 pointer-events-all"
            (clicked)="editInvoice()" matTooltip="Transactions">
          </app-button>
        </div>
      </dx-data-grid>
    </div>
  </div>

  <div class="d-none d-lg-flex flex-w-22">
    <div class="app-card h-100 ml-4 flex-grow-1">
      <app-no-data *ngIf="!showPanel" [showTitle]="false" text="Please select a patient from the list."
        class="w-100 flex responsive-paddings px-4 mt-40per"></app-no-data>

      <app-payment-tracking-view class="d-flex flex-grow-1" *ngIf="showPanel" [patientId]="patientId"
        [invoiceId]="invoiceId"></app-payment-tracking-view>
    </div>
  </div>
</div>